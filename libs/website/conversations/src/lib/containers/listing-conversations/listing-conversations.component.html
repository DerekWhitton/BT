<div class="p-grid">
  <div class="p-col-10 p-offset-1 p-md-10 p-md-offset-1 p-lg-8 p-lg-offset-2">
    <div class="thread p-card p-p-5 p-mt-5 p-mb-5">
      <p-toast position="top-center"></p-toast>
      <h1>Listing Conversations</h1>
      <p>Listing: {{ listingDetails?.name }}</p>
      <p>Price: R {{ listingDetails?.startingPrice }}</p>
      <progress-spinner *ngIf="loading"></progress-spinner>

      <div *ngIf="!loading" class="thread p-card p-mb-5">
        <ng-container *ngFor="let conv of purchaseConversations">
          <div class="p-mb-4 p-p-3 conversation-card" [ngClass]="conv.isWinner ? 'winner-purchase': ''">
            <div class="p-grid">
              <div class="p-col-12 p-md-6 p-lg-3 conversation-title">
                <div class="profile-image-container">
                  <img
                    src="{{ conv.buyerProfilePicture }}"
                    alt="User Profile Pic"
                  />
                </div>
                <p class="title-name">{{ conv.buyerName }}</p>
              </div>
              <div class="p-col-12 p-md-6 p-lg-6">
                <i class="pi pi-clock p-mr-1" style="font-size: 1rem;"></i>
                {{ conv.createdAt | date: 'dd MMM yyyy h:mm:ss' }}
              </div>
              <div class="p-col-12 p-md-6 p-lg-3">
                <button
                  *ngIf="!listingDetails?.isSold && !conv.dateCancelled"
                  pButton
                  pRipple
                  icon="pi pi-dollar"
                  title="Choose buyer"
                  class="p-button-rounded p-button-primary p-mr-2"
                  (click)="showWinnerConfirmation(conv.purchaseId)"
                ></button>
                <button
                  *ngIf="!listingDetails?.isSold || conv.isWinner"
                  pButton
                  pRipple
                  label="View details"
                  title="Go to conversation"
                  class="p-button-rounded p-button-primary p-mr-2"
                  [routerLink]="['../..', 'purchase', conv.id]"
                ></button>
              </div>
            </div>
          </div>
        </ng-container>
        <div
          *ngIf="purchaseConversations?.length == 0"
          class="conversation-card"
        >
          <h2>No conversations available.</h2>
        </div>
      </div>
    </div>
  </div>
</div>

<p-dialog
  [(visible)]="showConfirmationModal"
  [style]="{ width: '500px;' }"
  [header]="'Confirm chosen buyer'"
  [modal]="true"
  [closeOnEscape]="false"
  (onHide)="selectedConversation = null"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <p>
      Are you sure you want to choose {{ selectedConversation.buyerName }} as
      the buyer for this listing? This action cannot be undone.
    </p>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text"
      (click)="this.showConfirmationModal = false"
    ></button>
    <button
      pButton
      pRipple
      label="Confirm"
      icon="pi pi-check"
      class="p-button-text"
      (click)="confirmChosenWinner()"
    ></button>
  </ng-template>
</p-dialog>
