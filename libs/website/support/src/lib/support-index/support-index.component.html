<div class="p-grid">
  <div class="p-col-10 p-offset-1 p-md-10 p-md-offset-1 p-lg-8 p-lg-offset-2">
    <div class="thread p-card p-p-5 p-mt-5 p-mb-5">
      <div style="position: relative;">
        <h1>Support tickets</h1>
        <button
          pButton
          class="header-button"
          type="button"
          label="Add Support Ticket"
          (click)="showCreateSupportTicketModal = true;"
        ></button>
      </div>
      <hr />
      <div class="p-grid p-fluid p-p-3">
        <div class="p-col-12 p-md-6 p-lg-3">
          <span class="p-float-label">
            <p-dropdown id="categoryFilter" [showClear]="true" [options]="selectableTicketCategories" [autoDisplayFirst]="false" [(ngModel)]="filters.category"></p-dropdown>
            <label for="categoryFilter">Category</label>
          </span>
        </div>
        <div class="p-col-12 p-md-6 p-lg-3">
          <span class="p-float-label">
            <input id="queryFilter" pInputText type="text" [(ngModel)]="filters.query"/>
            <label for="queryFilter">Title</label>
          </span>
        </div>
        <div class="p-col-12 p-md-6 p-lg-3">
          <label style="display: inline;">Include closed:</label>
          <p-inputSwitch [(ngModel)]="filters.includeClosed"></p-inputSwitch>
        </div>
        <div class="p-col-12 p-md-6 p-lg-3">
          <button 
            pButton
            type="button"
            label="Apply filters"
            (click)="applyFilters()"
          ></button>
        </div>
      </div>
      
      <progress-spinner *ngIf="!(loaded$ | async)"></progress-spinner>
      <p *ngIf="error$ | async as errorMessage">{{errorMessage.message}}</p>

      <div *ngIf="loaded$ && supportTickets$ | async as tickets">
        <div class="thread p-card p-p-5 p-mb-5">
          <ng-container *ngFor="let ticket of tickets">
            <div class="p-mb-4 p-p-3 ticket-card">
              <div class="p-grid">
                <div class="p-col-12 p-md-6 p-lg-3">
                  <i class="pi pi-clock p-mr-1"
                    style="font-size: 1rem;"></i>
                  {{ ticket.createdAt | date: 'dd MMM yyyy h:mm:ss' }}
                </div>
                <div class="p-col-12 p-md-6 p-lg-3">
                  <p [routerLink]="[ticket.id]" class="ticket-title">{{ ticket.title }} (#{{ ticket.id.split('-')[0] }})</p>
                </div>
                <div class="p-col-12 p-md-6 p-lg-3">
                  Category: {{ ticket.category }}
                </div>
                <div class="p-col-12 p-md-6 p-lg-3">
                  Status: {{ ticket.isClosed ? 'Closed' : ticket.inProgress ? 'InProgress' : 'Open' }}
                </div>
              </div>
              <div class="p-col-12 p-md-6 p-lg-3">
                Messages: {{ ticket.messageCount }}
              </div>
            </div>
          </ng-container>

          <div class="p-grid">
            <div class="p-col-12 p-mt-3 p-mb-3 p-text-right">
              <a
                *ngIf="previousPage$ | async as page"
                (click)="loadPage(page)"
                class="p-mr-3"
                >Previous Page</a
              >
              <a *ngIf="nextPage$ | async as page" (click)="loadPage(page)"
                >Next Page</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<p-dialog
  [(visible)]="showCreateSupportTicketModal"
  [style]="{ width: '450px' }"
  [modal]="true"
  [closable]="false"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <form [formGroup]="addSupportTicketFormGroup">
      <div class="p-grid">
        <div class="p-col">
          <div class="p-fluid">
            <div class="p-field">
              <label>
                Category:
              </label>
              <p-dropdown [options]="selectableTicketCategories" [placeholder]="'Select a category'" formControlName="category"></p-dropdown>
            </div>
            <div class="p-field">
              <label>
                Title:
              </label>
              <input pInputText type="text" required formControlName="title" />
            </div>
            <div class="p-field">
              <label>
                Message (2500 characters maximum):
              </label>
              <textarea pInputText type="text" required formControlName="message"></textarea>
            </div>
          </div>
        </div>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text"
      (click)="hideCreateSupportTicketModal()"
    ></button>
    <button
      pButton
      pRipple
      class="p-button-text"
      icon="pi pi-check"
      label="Add ticket"
      [disabled]="!this.addSupportTicketFormGroup.valid"
      (click)="saveSupportTicket()"
    ></button>
  </ng-template>
</p-dialog>
