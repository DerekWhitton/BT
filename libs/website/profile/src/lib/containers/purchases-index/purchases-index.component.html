<div class="p-col-12 p-text-center" *ngIf="!(loaded$ | async)">
  <progress-spinner></progress-spinner>
</div>

<div *ngIf="(loaded$ | async) && purchases$ | async as purchases">
  <p *ngIf="purchases.length <= 0">
    We couldn't find any purchases associated with your account.
  </p>


  <p-table #dt [value]="purchases" *ngIf="purchases.length > 0" dataKey="id" [rows]="10" [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[25,50,100]" [loading]="loading" styleClass="p-datatable-customers" [paginator]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" [filterDelay]="0"
    [globalFilterFields]="['listing.name','amount']">
    <ng-template pTemplate="caption">
      <div class="table-header">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')"
            placeholder="Search Purchases" />
        </span>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>
          Type
        </th>
        <th>
          Listing
        </th>
        <th>
          Amount
        </th>
        <th>
          Status
        </th>
        <th></th>
      </tr>
      <tr>

        <th>
          <p-dropdown [options]="purchasetypes" (onChange)="dt.filter($event.value, 'listing.type', 'equals')"
            styleClass="p-column-filter" placeholder="All" [showClear]="true">
            <ng-template let-option pTemplate="item">
              <span [class]="'customer-badge status-' + option.value">{{option.label}}</span>
            </ng-template>
          </p-dropdown>
        </th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>

      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-purchase>
      <tr>
        <td>
          <span class="p-tag"
            [ngClass]="purchase.listing.type == listingType.Auction ? 'p-tag-success': 'p-tag-primary'">{{purchase.listing.type ==  listingType.Auction  ? 'Auction' : 'Listing'}}</span>
        </td>
        <td>
          {{ purchase.listing.name }}
        </td>
        <td>R{{ purchase.amount.toFixed(2) }}</td>
        <td *ngIf="purchase.dateCompleted && !purchase.dateReceivedGoods">
          Completed on {{ purchase.dateCompleted | date }}
        </td>
        <td *ngIf="purchase.dateCancelled">
          Cancelled on {{ purchase.dateCancelled | date }}
        </td>
        <td *ngIf="purchase.dateReceivedGoods">
          Received goods on {{ purchase.dateReceivedGoods | date }}
        </td>
        <td *ngIf="!purchase.dateCompleted && !purchase.dateCancelled && !purchase.dateReceivedGoods">
          Pending
        </td>
        <td>
          <div
            *ngIf="!purchase.dateCompleted && !purchase.dateCancelled && purchase.listing.type == listingType.Auction">
            <button pButton (click)="initiatePayment(purchase.id)" icon="pi pi-money-bill" class="p-mr-2 p-button-success"
              pTooltip="Pay to complete purchase" tooltipPosition="right"></button>
            <button pButton (click)="cancelPurchase(purchase.id)" icon="pi pi-ban" class="p-mr-2 p-button-danger"
              pTooltip="Cancel the purchase." tooltipPosition="right"></button>
          </div>
          <div>
            <button pButton *ngIf="purchase.conversationId" icon="pi pi-comments"
              [routerLink]="['../..', 'conversations', 'purchase', purchase.conversationId]"
              pTooltip="View all messages between you and the seller on this purchase." tooltipPosition="right"
              class="p-mr-2"></button>
            <button *ngIf="purchase.dateCompleted && purchase.listing.type == listingType.Auction && !purchase.dateReceivedGoods" pButton
              style="margin-top: 5px;" class="p-mr-2 p-button-raised p-button-success" icon="pi pi-thumbs-up"
              pTooltip="Click here if you have received the goods, to complete the transaction."
              tooltipPosition="right" (click)="markReceivedGoods(purchase.id)"></button>
            <button *ngIf="purchase.dateCompleted && purchase.listing.type == listingType.Auction" pButton
              style="margin-top: 5px;" class="p-mr-2 p-button-raised p-button-warning" icon="pi pi-bell"
              pTooltip="Click here if there is a problem with your transaction." tooltipPosition="right"></button>
            <button
              *ngIf="!purchase.dateCompleted && !purchase.dateCancelled && purchase.listing.type == listingType.Sale"
              pButton (click)="cancelPurchase(purchase.id)" icon="pi pi-times"
              pTooltip="This will cancel your purchase." tooltipPosition="right"
              class="p-mr-2 p-button-danger"></button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6">No customers found.</td>
      </tr>
    </ng-template>
  </p-table>


</div>

<bushtrade-portal-initiate-payment [showPurchaseDetailDialog]="showPurchaseDetailDialog"
  [paymentDetailsLoaded$]="paymentDetailsLoaded$ | async" [paymentDetails$]="paymentDetails$ | async"
  (modalClosed)="showPurchaseDetailDialog = false"></bushtrade-portal-initiate-payment>
