<div class="p-col-12 p-text-center" *ngIf="!(loaded$ | async)">
  <progress-spinner></progress-spinner>
</div>

<div *ngIf="(loaded$ | async) && purchases$ | async as purchases">
  <p *ngIf="purchases.length <= 0">
    We couldn't find any purchases associated with your account.
  </p>
  <p-table [value]="purchases" *ngIf="purchases.length > 0">
    <ng-template pTemplate="header">
      <tr>
        <th>
          Listing
        </th>
        <th>
          Amount
        </th>
        <th>
          Status
        </th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-purchase>
      <tr>
        <td>
          {{ purchase.listing.name }}
        </td>
        <td>R{{ purchase.bid.amount.toFixed(2) }}</td>
        <td *ngIf="purchase.dateCompleted">
          Completed on {{ purchase.dateCompleted | date }}
        </td>
        <td *ngIf="purchase.dateCancelled">
          Cancelled on {{ purchase.dateCancelled | date }}
        </td>
        <td *ngIf="!purchase.dateCompleted && !purchase.dateCancelled">
          Pending
        </td>
        <td>
          <div
            *ngIf="!purchase.dateCompleted && !purchase.dateCancelled && purchase.listing.type == listingType.Auction"
          >
            <p-button
              label="Pay Now"
              (click)="initiatePayment(purchase.id)"
            ></p-button>
            <p-button
              label="Cancel Purchase"
              (click)="cancelPurchase(purchase.id)"
            ></p-button>
          </div>
          <div>
            <p-button
              *ngIf="purchase.conversationId"
              icon="pi pi-comments"
              [routerLink]="['../..', 'conversations', 'purchase', purchase.conversationId]"
            ></p-button>
            <button
              *ngIf="purchase.dateCompleted && purchase.listing.type == listingType.Auction"
              pButton
              style="margin-top: 5px;"
              class="p-button-raised p-button-success"
              label="Received goods"
            ></button>
            <button
              *ngIf="purchase.dateCompleted && purchase.listing.type == listingType.Auction"
              pButton
              style="margin-top: 5px;"
              class="p-button-raised p-button-danger"
              label="Dispute"
            ></button>
            <p-button
              *ngIf="!purchase.dateCompleted && !purchase.dateCancelled && purchase.listing.type == listingType.Sale"
              label="Cancel Purchase"
              (click)="cancelPurchase(purchase.id)"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<bushtrade-portal-initiate-payment
  [showPurchaseDetailDialog]="showPurchaseDetailDialog"
  [paymentDetailsLoaded$]="paymentDetailsLoaded$ | async"
  [paymentDetails$]="paymentDetails$ | async"
  (modalClosed)="showPurchaseDetailDialog = false"
></bushtrade-portal-initiate-payment>
