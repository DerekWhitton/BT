<ng-container *ngIf="sellers">
  <ng-container *ngIf="sellers?.length > 0; else register">
    <p-tabMenu [model]="sellers">
      <ng-template pTemplate="item" let-seller let-i="index">
        <a (click)="loadListings(seller)">{{ seller.name }}</a>
      </ng-template>
    </p-tabMenu>

    <p-toast position="top-center"></p-toast>
    <progress-spinner
      *ngIf="!(loading$ | async); else table"
    ></progress-spinner>
    <ng-template #table>
      <p-toolbar styleClass="p-mb-4">
        <ng-template pTemplate="left">
          <button
            *ngIf="addOrUpdateListingTemplate"
            pButton
            pRipple
            label="New Listing"
            icon="pi pi-plus"
            class="p-button-success p-mr-1"
            (click)="initializeListingForm(); displayCreateUpdateDialog = true"
          ></button>
        </ng-template>
      </p-toolbar>
      <p-table [columns]="columns" [value]="listings$ | async">
        <ng-template pTemplate="header" let-columns>
          <tr>
            <th *ngFor="let col of columns">
              {{ col.header }}
            </th>
            <th style="text-align: right;">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rowData let-columns="columns">
          <tr>
            <td
              *ngFor="let col of columns"
              [innerHtml]="
                col.converter
                  ? col.converter(rowData[col.field])
                  : rowData[col.field]
              "
            ></td>
            <td class="p-text-right">
              <button
                *ngIf="
                  addOrUpdateListingTemplate &&
                  (rowData.type != ListingType.Auction || !rowData.active)
                "
                pButton
                pRipple
                icon="pi pi-pencil"
                class="p-button-rounded p-button-success p-mr-2"
                (click)="handleUpdateSelection(rowData)"
              ></button>
              <button
                pButton
                pRipple
                icon="pi pi-trash"
                class="p-button-rounded p-button-warning"
                (click)="deleteListing(rowData)"
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-template>
  </ng-container>
</ng-container>

<ng-template #register>
  <button
    pButton
    icon=""
    label="Start Selling"
    (click)="this.displayStartSellingDialog = true"
  ></button>
</ng-template>

<p-dialog
  [(visible)]="displayCreateUpdateDialog"
  [style]="{ width: '800px' }"
  [header]="'Add New Listing'"
  [modal]="true"
  [closeOnEscape]="false"
  (onHide)="clearForm()"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <ng-container *ngTemplateOutlet="addOrUpdateListingTemplate">
    </ng-container>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text"
      (click)="displayCreateUpdateDialog = false"
    ></button>
    <button
      pButton
      pRipple
      label="Save"
      icon="pi pi-check"
      class="p-button-text"
      [disabled]="!addlistingFormGroup.valid"
      (click)="saveListing()"
    ></button>
  </ng-template>
</p-dialog>

<ng-template #addOrUpdateListingTemplate>
  <ng-template #initializingEditModalData>
    <progress-spinner></progress-spinner>
  </ng-template>
  <form
    [formGroup]="addlistingFormGroup"
    *ngIf="!editModalDataIsInitializing; else initializingEditModalData"
  >
    <div class="p-grid">
      <div class="p-col">
        <div class="p-fluid">
          <h3>Basic Information</h3>
          <!-- name -->
          <div class="p-field">
            <label>
              Listing Title:
            </label>
            <input pInputText type="text" required formControlName="name" />
          </div>

          <!-- type -->
          <div class="p-field">
            <label
              pTooltip="Auctions have a duration of two weeks from the created date."
            >
              Listing Type: <i class="pi pi-question-circle"></i>
            </label>
            <p-selectButton
              [options]="selectableListingTypeOptions"
              formControlName="type"
            ></p-selectButton>
          </div>

          <!-- description -->
          <div class="p-field">
            <label>
              Description of Item:
            </label>
            <textarea
              style="width: 100%;"
              pInputTextarea
              [rows]="5"
              type="text"
              required
              formControlName="description"
              autoResize="autoResize"
              maxlength="2500"
            ></textarea>
          </div>

          <!-- category -->
          <div class="p-field">
            <label pTooltip="Click the category if you need to change it.">
              Listing Category:
            </label>
            <br />
            <bushtrade-category-selector
              [categoryTree]="categoryTree"
              [loading]="loadingCategories"
              [selectedCategoryId]="addlistingFormGroup.get('categoryId').value"
              (categorySelected)="handleCategorySelection($event)"
              (chainComplete)="handleCategoryChainComplete($event)"
            ></bushtrade-category-selector>
          </div>

          <hr />
          <h3>Images of Item</h3>
          <!-- images -->
          <div class="p-field">
            <label pTooltip="You can upload up to 10 images.">
              Upload Images For Listing: <i class="pi pi-question-circle"></i>
            </label>
            <p-fileUpload
              #fileUpload
              name="myfile[]"
              mode="basic"
              customUpload="true"
              (uploadHandler)="uploadListingImage($event)"
              multiple="multiple"
              accept="image/*"
              auto="true"
              chooseLabel="Upload Images"
              fileLimit="10"
            >
            </p-fileUpload>

            <p *ngIf="isUploadingImageFiles">
              Uploading Files...
              <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
            </p>
            <div class="p-grid p-mt-2">
              <div class="p-col-3" *ngFor="let image of images">
                <bushtrade-listing-image-preview
                  (removed)="handleImageRemoval(image.id)"
                  [src]="image.src"
                ></bushtrade-listing-image-preview>
              </div>
            </div>
          </div>

          <hr />
          <h3>Price</h3>
          <!-- starting price -->
          <div class="p-field">
            <label>
              {{
                addlistingFormGroup.get('type').value == ListingType.Auction
                  ? 'Starting Price'
                  : 'Price'
              }}
            </label>
            <input
              pInputText
              type="number"
              required
              formControlName="startingPrice"
              (change)="checkReserve()"
            />
          </div>

          <!-- starting price -->
          <div
            class="p-field"
            *ngIf="addlistingFormGroup.get('type').value == ListingType.Auction"
          >
            <label
              pTooltip="The reserve price cannot be lower than the starting price."
            >
              Reserve Price: <i class="pi pi-question-circle"></i>
            </label>
            <input
              pInputText
              type="number"
              required
              formControlName="reservePrice"
              (change)="checkReserve()"
            />
          </div>

          <!-- duration -->
          <div
            class="p-field"
            *ngIf="addlistingFormGroup.get('type').value == ListingType.Auction"
          >
            <label
              pTooltip="The EndDate will be calculated based on the duration immediately after you activate the Auction."
            >
              Duration: <i class="pi pi-question-circle"></i>
            </label>
            <p-selectButton
              [options]="selectableAuctionDurationSettings"
              formControlName="durationInDays"
            ></p-selectButton>
          </div>

          <!-- increment -->
          <div
            class="p-field"
            *ngIf="addlistingFormGroup.get('type').value == ListingType.Auction"
          >
            <label pTooltip="The minimum increment between bids">
              Price Increment: <i class="pi pi-question-circle"></i>
            </label>
            <input
              pInputText
              type="number"
              required
              formControlName="priceIncrement"
            />
          </div>

          <!-- quantity -->
          <div class="p-field" style="display: none;">
            <label>
              Quantity:
            </label>
            <p-inputNumber formControlName="quantity"></p-inputNumber>
          </div>

          <!-- other category properties -->
          <ng-container *ngIf="showProperties == true">
            <div
              class="p-field"
              *ngFor="let property of categoryProperties; let i = index"
            >
              <label> {{ property.name }}: </label>
              <input
                pInputText
                type="text"
                [(ngModel)]="categoryProperties[i].value"
                [ngModelOptions]="{ standalone: true }"
                *ngIf="property.type == CategoryPropertyType.Text"
              />

              <p-inputNumber
                [(ngModel)]="categoryProperties[i].value"
                [ngModelOptions]="{ standalone: true }"
                mode="decimal"
                *ngIf="property.type == CategoryPropertyType.Numeric"
              ></p-inputNumber>

              <p-dropdown
                [options]="property.selectableOptions"
                [(ngModel)]="categoryProperties[i].value"
                [ngModelOptions]="{ standalone: true }"
                *ngIf="property.type == CategoryPropertyType.SingleSelect"
              ></p-dropdown>
            </div>
          </ng-container>

          <!-- active -->
          <div class="p-field">
            <label>
              Active:
            </label>
            <br />
            <p-inputSwitch formControlName="active"></p-inputSwitch>
          </div>
          <div
            class="p-field"
            *ngIf="
              addlistingFormGroup.get('type').value == ListingType.Auction &&
              addlistingFormGroup.get('active').value === true &&
              !addlistingFormGroup.get('durationInDays').value
            "
          >
            <p-message
              severity="error"
              text="When activating an Auction, you must provide a value for the Duration"
            ></p-message>
          </div>
          <div
            class="p-field"
            *ngIf="
              addlistingFormGroup.get('type').value == ListingType.Auction &&
              addlistingFormGroup.get('active').value === true
            "
          >
            <p-message
              severity="warn"
              text="Once submitted as Active, an Auction will not be editable anymore"
            ></p-message>
          </div>
        </div>
      </div>
    </div>
  </form>
</ng-template>

<p-dialog
  [(visible)]="displayStartSellingDialog"
  header="Create Seller Profile"
  [style]="{ width: '450px' }"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <form [formGroup]="signUpSellerFormGroup">
      <div class="p-grid">
        <div class="p-col">
          <div class="p-fluid"></div>
          <div class="p-field">
            <label>
              Trade in your Private Capacity:
            </label>
            <br />
            <p-inputSwitch
              (onChange)="handleChange($event)"
              formControlName="isPrivateIndividual"
            ></p-inputSwitch>
          </div>

          <div [ngStyle]="{ display: isPrivate ? 'none' : 'block' }">
            <h2>Trading Details</h2>
            <div class="p-field">
              <label>
                Name:
              </label>
              <input pInputText type="text" required formControlName="name" />
            </div>
            <div class="p-field">
              <label>
                Company Number:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="ckNumber"
              />
            </div>
            <div class="p-field">
              <label>
                Tax Number:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="taxNumber"
              />
            </div>
          </div>

          <h2>Banking Details</h2>
          <div class="p-field">
            <label>
              Bank:
            </label>
            <input pInputText type="text" required formControlName="bank" />
          </div>
          <div class="p-field">
            <label>
              Branch Code:
            </label>
            <input
              pInputText
              type="text"
              required
              formControlName="branchCode"
            />
          </div>
          <div class="p-field">
            <label>
              Account Type:
            </label>
            <input
              pInputText
              type="text"
              required
              formControlName="accountType"
            />
          </div>
          <div class="p-field">
            <label>
              Account Number:
            </label>
            <input
              pInputText
              type="text"
              required
              formControlName="accountNumber"
            />
          </div>
        </div>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text p-button-danger"
      (click)="this.displayStartSellingDialog = false"
    ></button>
    <button
      pButton
      pRipple
      class="p-button-text"
      icon="pi pi-check"
      label="Start Selling!"
      (click)="registerSeller()"
    ></button>
  </ng-template>
</p-dialog>
