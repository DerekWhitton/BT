<ng-container *ngIf="sellers$ | async as sellers">
  <p-accordion
    *ngIf="sellers?.length > 0; else register"
    (onOpen)="loadListings(sellers[$event.index])"
  >
    <p-accordionTab
      *ngFor="let seller of sellers"
      [header]="seller.name"
      transitionOptions="100ms cubic-bezier(0.86, 0, 0.07, 1)"
    >
      <bushtrade-web-crud-table
        [data]="listings$ | async"
        [selectableColumns]="columns"
        [loading]="loading$ | async"
        [createFormTemplateReference]="addOrUpdateListingTemplate"
        (updateSelection)="handleUpdateSelection($event)"
        (createSelection)="handleCreateSelection()"
        [updateFormTemplateReference]="addOrUpdateListingTemplate"
        (updateSubmit)="saveListing()"
        [headersValue]="'Listing'"
        [createFormValid]="addlistingFormGroup.valid"
        (createSubmit)="saveListing()"
        [allowDelete]="true"
        (itemDeleted)="deleteListing($event)"
        modalWidth="460px"
        searchable="false"
      ></bushtrade-web-crud-table>
    </p-accordionTab>
  </p-accordion>
</ng-container>

<ng-template #register>
  <button
  pButton
  icon=""
  label="Start Selling"
  (click)="this.displayStartSellingDialog = true"
  ></button>
</ng-template>



<ng-template #addOrUpdateListingTemplate>
  <ng-template #initializingEditModalData>
    <progress-spinner></progress-spinner>
  </ng-template>
  <form
    [formGroup]="addlistingFormGroup"
    *ngIf="!editModalDataIsInitializing; else initializingEditModalData"
  >
    <div class="p-grid">
      <div class="p-col">
        <div class="p-fluid">
          <!-- name -->
          <div class="p-field">
            <label>
              Name:
            </label>
            <input pInputText type="text" required formControlName="name" />
          </div>

          <!-- type -->
          <div class="p-field">
            <label>
              Type:
            </label>
            <p-dropdown
              [options]="selectableListingTypeOptions"
              formControlName="type"
            ></p-dropdown>
          </div>

          <!-- images -->
          <div class="p-field">
            <label>
              Images:
            </label>
            <p-fileUpload
              #fileUpload
              name="myfile[]"
              customUpload="true"
              (uploadHandler)="uploadListingImage($event)"
              multiple="multiple"
            ></p-fileUpload>

            <p *ngIf="isUploadingImageFiles">
              Uploading...
            </p>
            <div class="p-grid p-mt-2">
              <div class="p-col-3" *ngFor="let image of images">
                <bushtrade-listing-image-preview
                  (removed)="handleImageRemoval(image.id)"
                  [src]="image.src"
                ></bushtrade-listing-image-preview>
              </div>
            </div>
          </div>

          <!-- description -->
          <div class="p-field">
            <label>
              Description:
            </label>
            <textarea
              style="width: 100%;"
              pInputTextarea
              type="text"
              required
              formControlName="description"
              autoResize="autoResize"
            ></textarea>
          </div>

          <!-- category -->
          <div class="p-field">
            <label>
              Category:
            </label>
            <bushtrade-category-selector
              [categoryTree]="categoryTree"
              [loading]="loadingCategories"
              [selectedCategoryId]="addlistingFormGroup.get('categoryId').value"
              (categorySelected)="handleCategorySelection($event)"
              (chainComplete)="handleCategoryChainComplete($event)"
            ></bushtrade-category-selector>
          </div>

          <!-- starting price -->
          <div class="p-field">
            <label>
              {{
                addlistingFormGroup.get('type').value == ListingType.Auction
                  ? 'Starting Price'
                  : 'Price'
              }}
            </label>
            <input
              pInputText
              type="number"
              required
              formControlName="startingPrice"
            />
          </div>

          <!-- starting price -->
          <div
            class="p-field"
            *ngIf="addlistingFormGroup.get('type').value == ListingType.Auction"
          >
            <label>
              Reserve Price:
            </label>
            <input
              pInputText
              type="number"
              required
              formControlName="reservePrice"
            />
          </div>

          <!-- increment -->
          <div
            class="p-field"
            *ngIf="addlistingFormGroup.get('type').value == ListingType.Auction"
          >
            <label>
              Price Increment:
            </label>
            <input
              pInputText
              type="number"
              required
              formControlName="priceIncrement"
            />
          </div>

          <!-- quantity -->
          <div class="p-field">
            <label>
              Quantity:
            </label>
            <p-inputNumber formControlName="quantity"></p-inputNumber>
          </div>

          <!-- other category properties -->
          <ng-container *ngIf="showProperties == true">
            <div
              class="p-field"
              *ngFor="let property of categoryProperties; let i = index"
            >
              <label> {{ property.name }}: </label>
              <input
                pInputText
                type="text"
                [(ngModel)]="categoryProperties[i].value"
                [ngModelOptions]="{ standalone: true }"
                *ngIf="property.type == CategoryPropertyType.Text"
              />

              <p-inputNumber
                [(ngModel)]="categoryProperties[i].value"
                [ngModelOptions]="{ standalone: true }"
                mode="decimal"
                *ngIf="property.type == CategoryPropertyType.Numeric"
              ></p-inputNumber>

              <p-dropdown
                [options]="property.selectableOptions"
                [(ngModel)]="categoryProperties[i].value"
                [ngModelOptions]="{ standalone: true }"
                *ngIf="property.type == CategoryPropertyType.SingleSelect"
              ></p-dropdown>
            </div>
          </ng-container>

          <!-- active -->
          <div class="p-field">
            <label>
              Active:
            </label>
            <br />
            <p-inputSwitch formControlName="active"></p-inputSwitch>
          </div>
        </div>
      </div>
    </div>
  </form>
</ng-template>

<p-dialog
  [(visible)]="displayStartSellingDialog"
  header="Create Seller Profile" 
  [style]="{ width: '450px' }"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <form [formGroup]="signUpSellerFormGroup">
      <div class="p-grid">
        <div class="p-col">
          <div class="p-fluid">
          </div>
          <div class="p-field">
            <label>
              Trade in your Private Capacity:
            </label>
            <br />
            <p-inputSwitch 
              (onChange)="handleChange($event)"
              formControlName="isPrivateIndividual"
            ></p-inputSwitch> 
          </div>

          <div [ngStyle]="{'display': isPrivate ? 'none' : 'block' }" >
            
            <h2>Trading Details</h2>
            <div class="p-field" >
              <label>
                Name:
              </label>
              <input pInputText type="text" required formControlName="name" />
            </div>
            <div class="p-field" >
              <label>
                Company Number:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="ckNumber"
              />
            </div>
            <div class="p-field">
              <label>
                Tax Number:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="taxNumber"
              />
          </div>

          </div>

            <h2>Banking Details</h2>
            <div class="p-field">
              <label>
                Bank:
              </label>
              <input pInputText type="text" required formControlName="bank" />
            </div>
            <div class="p-field">
              <label>
                Branch Code:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="branchCode"
              />
            </div>
            <div class="p-field">
              <label>
                Account Type:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="accountType"
              />
            </div>
            <div class="p-field">
              <label>
                Account Number:
              </label>
              <input
                pInputText
                type="text"
                required
                formControlName="accountNumber"
              />
            </div>

        </div>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text p-button-danger"
      (click)="this.displayStartSellingDialog = false"

    ></button>
    <button
      pButton
      pRipple
      class="p-button-text"
      icon="pi pi-check"
      label="Start Selling!"
      (click)="registerSeller()"
    ></button>
  </ng-template>
</p-dialog>
